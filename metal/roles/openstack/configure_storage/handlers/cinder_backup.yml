---
- name: Create Ceph pool for Cinder Backup
  ansible.builtin.command: ceph osd pool create backups

- name: Initialize Cinder Backup pool for RBD
  ansible.builtin.command: rbd pool init backups

- name: Create Ceph user for Cinder Backup
  ansible.builtin.command: ceph auth get-or-create client.cinder-backup mon 'profile rbd' osd 'profile rbd pool=backups' mgr 'profile rbd pool=backups'
  register: ceph_cinder_backup_user

# We remove the indentation generated by Ceph here (it breaks Kolla Ansible's INI parser)
- name: Write out Cinder Backup user's keyring to file
  ansible.builtin.copy:
    content: "{{ ceph_cinder_backup_user.stdout | regex_replace('^\\s+', '') | regex_replace('\\n\\s+', '\\n') }}\n"
    dest: /etc/kolla/config/cinder/cinder-backup/ceph.client.cinder-backup.keyring
    mode: 0640
