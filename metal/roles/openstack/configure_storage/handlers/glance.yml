---
- name: Create Ceph pool for Glance
  ansible.builtin.command: ceph osd pool create images

- name: Initialize Glance pool for RBD
  ansible.builtin.command: rbd pool init images

- name: Create Ceph user for Glance
  ansible.builtin.command: ceph auth get-or-create client.glance mon 'profile rbd' osd 'profile rbd pool=images' mgr 'profile rbd pool=images'
  register: ceph_glance_user

# We remove the indentation generated by Ceph here (it breaks Kolla Ansible's INI parser)
- name: Write out Glance user's keyring to file
  ansible.builtin.copy:
    content: "{{ ceph_glance_user.stdout | regex_replace('^\\s+', '') | regex_replace('\\n\\s+', '\\n') }}\n"
    dest: /etc/kolla/config/glance/ceph.client.glance.keyring
    mode: 0640

- name: Template the Glance ceph.conf file
  ansible.builtin.template:
    src: ceph.conf.j2
    dest: /etc/kolla/config/glance/ceph.conf
    mode: 0640
