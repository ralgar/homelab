---
- name: Create Ceph pool for Cinder
  ansible.builtin.command: ceph osd pool create volumes

- name: Initialize Cinder pool for RBD
  ansible.builtin.command: rbd pool init volumes

- name: Create Ceph user for Cinder
  ansible.builtin.command: ceph auth get-or-create client.cinder mon 'profile rbd' osd 'profile rbd pool=volumes, profile rbd pool=vms, profile rbd-read-only pool=images' mgr 'profile rbd pool=volumes, profile rbd pool=vms'
  register: ceph_cinder_user

# We remove the indentation generated by Ceph here (it breaks Kolla Ansible's INI parser)
- name: Write out Cinder user's keyring to file
  ansible.builtin.copy:
    content: "{{ ceph_cinder_user.stdout | regex_replace('^\\s+', '') | regex_replace('\\n\\s+', '\\n') }}\n"
    dest: "{{ ceph_cinder_keyring_file }}"
    mode: 0640
  loop:
    - /etc/kolla/config/cinder/cinder-backup/ceph.client.cinder.keyring
    - /etc/kolla/config/cinder/cinder-volume/ceph.client.cinder.keyring
    - /etc/kolla/config/nova/ceph.client.cinder.keyring
  loop_control:
    loop_var: ceph_cinder_keyring_file

- name: Template the Cinder ceph.conf file
  ansible.builtin.template:
    src: ceph.conf.j2
    dest: /etc/kolla/config/cinder/ceph.conf
    mode: 0640
