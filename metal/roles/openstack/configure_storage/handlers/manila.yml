---
- name: Create CephFS pools for Manila
  ansible.builtin.command: "ceph osd pool create {{ cephfs_pool }}"
  loop:
    - cephfs_data
    - cephfs_metadata
  loop_control:
    loop_var: cephfs_pool

- name: Initialize CephFS 'shares' for Manila
  ansible.builtin.command: ceph fs new shares cephfs_metadata cephfs_data

- name: Deploy Ceph MDS daemon in the cluster
  ansible.builtin.command: ceph orch apply mds shares --placement=1

- name: Create Ceph user for Manila
  ansible.builtin.command: ceph auth get-or-create client.manila mgr 'allow rw' mon 'allow r'
  register: ceph_manila_user

# We remove the indentation generated by Ceph here (it breaks Kolla Ansible's INI parser)
- name: Write out Manila user's keyring to file
  ansible.builtin.copy:
    content: "{{ ceph_manila_user.stdout | regex_replace('^\\s+', '') | regex_replace('\\n\\s+', '\\n') }}\n"
    dest: /etc/kolla/config/manila/ceph.client.manila.keyring
    mode: 0640

- name: Template the Manila ceph.conf file
  ansible.builtin.template:
    src: ceph.conf.j2
    dest: /etc/kolla/config/manila/ceph.conf
    mode: 0640
